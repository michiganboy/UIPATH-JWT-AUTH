<?xml version="1.0" encoding="UTF-8" ?>
<Activity
  x:Class="SalesforceJWT.Main"
  xmlns="http://schemas.microsoft.com/netfx/2009/xaml/activities"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:s="clr-namespace:System;assembly=mscorlib"
  xmlns:scg="clr-namespace:System.Collections.Generic;assembly=mscorlib"
  xmlns:ui="http://schemas.uipath.com/workflow/activities">
  <x:Members>
    <x:Property Name="AccessToken" Type="OutArgument(x:String)" />
    <x:Property Name="InstanceUrl" Type="OutArgument(x:String)" />
    <x:Property Name="TokenExpiry" Type="OutArgument(x:DateTime)" />
  </x:Members>

  <Sequence DisplayName="Salesforce JWT Authentication">
    <Sequence.Variables>
      <!--  Variables  -->
      <Variable Name="ClientId" x:TypeArguments="s:String" />
      <Variable Name="Username" x:TypeArguments="s:String" />
      <Variable Name="LoginUrl" x:TypeArguments="s:String" />
      <Variable Name="PrivateKeyPath" x:TypeArguments="s:String" />
      <Variable Name="TokenEndpoint" x:TypeArguments="s:String" />
      <Variable Name="ExpiryBuffer" x:TypeArguments="s:Int32" />
      <Variable Name="MaxRetries" x:TypeArguments="s:Int32" />
      <Variable Name="RetryDelay" x:TypeArguments="s:Int32" />
      <Variable Name="LogLevel" x:TypeArguments="s:String" />
      <Variable Name="EnableDetailedLogging" x:TypeArguments="s:Boolean" />
      <Variable Name="AccessToken" x:TypeArguments="s:String" />
      <Variable Name="InstanceUrl" x:TypeArguments="s:String" />
      <Variable Name="TokenExpiry" x:TypeArguments="s:DateTime" />
      <Variable Name="IsValid" x:TypeArguments="s:Boolean" />
      <Variable Name="ErrorMessage" x:TypeArguments="s:String" />
    </Sequence.Variables>
    <!--  Load Configuration  -->
    <ui:InvokeWorkflowFile DisplayName="Load Configuration" WorkflowFileName="Activities\LoadConfiguration.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:Key="ClientId" x:TypeArguments="s:String">[ClientId]</InArgument>
        <InArgument x:Key="Username" x:TypeArguments="s:String">[Username]</InArgument>
        <InArgument x:Key="LoginUrl" x:TypeArguments="s:String">[LoginUrl]</InArgument>
        <InArgument x:Key="PrivateKeyPath" x:TypeArguments="s:String">[PrivateKeyPath]</InArgument>
        <InArgument x:Key="TokenEndpoint" x:TypeArguments="s:String">[TokenEndpoint]</InArgument>
        <InArgument x:Key="ExpiryBuffer" x:TypeArguments="s:Int32">[ExpiryBuffer]</InArgument>
        <InArgument x:Key="MaxRetries" x:TypeArguments="s:Int32">[MaxRetries]</InArgument>
        <InArgument x:Key="RetryDelay" x:TypeArguments="s:Int32">[RetryDelay]</InArgument>
        <InArgument x:Key="LogLevel" x:TypeArguments="s:String">[LogLevel]</InArgument>
        <InArgument x:Key="EnableDetailedLogging" x:TypeArguments="s:Boolean">[EnableDetailedLogging]</InArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>

    <!--  Get Salesforce Token  -->
    <ui:InvokeWorkflowFile DisplayName="Get Salesforce Token" WorkflowFileName="Activities\GetSalesforceToken.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:Key="ClientId" x:TypeArguments="s:String">[ClientId]</InArgument>
        <InArgument x:Key="Username" x:TypeArguments="s:String">[Username]</InArgument>
        <InArgument x:Key="LoginUrl" x:TypeArguments="s:String">[LoginUrl]</InArgument>
        <InArgument x:Key="PrivateKeyPath" x:TypeArguments="s:String">[PrivateKeyPath]</InArgument>
        <OutArgument x:Key="AccessToken" x:TypeArguments="s:String">[AccessToken]</OutArgument>
        <OutArgument x:Key="InstanceUrl" x:TypeArguments="s:String">[InstanceUrl]</OutArgument>
        <OutArgument x:Key="TokenExpiry" x:TypeArguments="s:DateTime">[TokenExpiry]</OutArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>

    <!--  Validate Token  -->
    <ui:InvokeWorkflowFile DisplayName="Validate Token" WorkflowFileName="Activities\ValidateToken.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:Key="AccessToken" x:TypeArguments="s:String">[AccessToken]</InArgument>
        <InArgument x:Key="InstanceUrl" x:TypeArguments="s:String">[InstanceUrl]</InArgument>
        <OutArgument x:Key="IsValid" x:TypeArguments="s:Boolean">[IsValid]</OutArgument>
        <OutArgument x:Key="ErrorMessage" x:TypeArguments="s:String">[ErrorMessage]</OutArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>

    <!--  Log Results  -->
    <If DisplayName="Check Authentication Result">
      <If.Condition>
        <InArgument x:TypeArguments="s:Boolean">[IsValid]</InArgument>
      </If.Condition>
      <If.Then>
        <ui:LogMessage
          DisplayName="Authentication Successful"
          Level="Info"
          Message="[&quot;Salesforce JWT Authentication successful. Token expires at: &quot; + TokenExpiry.ToString()]" />
      </If.Then>
      <If.Else>
        <Sequence DisplayName="Authentication Failed Actions">
          <ui:LogMessage
            DisplayName="Authentication Failed"
            Level="Error"
            Message="[&quot;Salesforce JWT Authentication failed: &quot; + ErrorMessage]" />
          <ui:LogMessage
            DisplayName="Stopping Workflow"
            Level="Error"
            Message="Workflow stopped due to authentication failure" />
        </Sequence>
      </If.Else>
    </If>

  </Sequence>
</Activity>
