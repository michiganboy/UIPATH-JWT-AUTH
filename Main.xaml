<?xml version="1.0" encoding="UTF-8"?>
<Activity x:Class="SalesforceJWT.Main" xmlns="http://schemas.microsoft.com/netfx/2009/xaml/activities" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:ui="http://schemas.uipath.com/workflow/activities" xmlns:s="clr-namespace:System;assembly=mscorlib" xmlns:scg="clr-namespace:System.Collections.Generic;assembly=mscorlib">
  <Sequence DisplayName="Salesforce JWT Authentication">
    <!-- Variables -->
    <Variable x:TypeArguments="x:String" Name="ClientId" />
    <Variable x:TypeArguments="x:String" Name="Username" />
    <Variable x:TypeArguments="x:String" Name="LoginUrl" />
    <Variable x:TypeArguments="x:String" Name="PrivateKeyPath" />
    <Variable x:TypeArguments="x:String" Name="TokenEndpoint" />
    <Variable x:TypeArguments="x:Int32" Name="ExpiryBuffer" />
    <Variable x:TypeArguments="x:Int32" Name="MaxRetries" />
    <Variable x:TypeArguments="x:Int32" Name="RetryDelay" />
    <Variable x:TypeArguments="x:String" Name="LogLevel" />
    <Variable x:TypeArguments="x:Boolean" Name="EnableDetailedLogging" />
    <Variable x:TypeArguments="x:String" Name="AccessToken" />
    <Variable x:TypeArguments="x:String" Name="InstanceUrl" />
    <Variable x:TypeArguments="s:DateTime" Name="TokenExpiry" />
    <Variable x:TypeArguments="x:Boolean" Name="IsValid" />
    <Variable x:TypeArguments="x:String" Name="ErrorMessage" />
    
    <!-- Load Configuration -->
    <ui:InvokeWorkflowFile DisplayName="Load Configuration" WorkflowFileName="Activities\LoadConfiguration.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:TypeArguments="x:String" x:Key="ClientId">[ClientId]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="Username">[Username]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="LoginUrl">[LoginUrl]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="PrivateKeyPath">[PrivateKeyPath]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="TokenEndpoint">[TokenEndpoint]</InArgument>
        <InArgument x:TypeArguments="x:Int32" x:Key="ExpiryBuffer">[ExpiryBuffer]</InArgument>
        <InArgument x:TypeArguments="x:Int32" x:Key="MaxRetries">[MaxRetries]</InArgument>
        <InArgument x:TypeArguments="x:Int32" x:Key="RetryDelay">[RetryDelay]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="LogLevel">[LogLevel]</InArgument>
        <InArgument x:TypeArguments="x:Boolean" x:Key="EnableDetailedLogging">[EnableDetailedLogging]</InArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>
    
    <!-- Get Salesforce Token -->
    <ui:InvokeWorkflowFile DisplayName="Get Salesforce Token" WorkflowFileName="Activities\GetSalesforceToken.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:TypeArguments="x:String" x:Key="ClientId">[ClientId]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="Username">[Username]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="LoginUrl">[LoginUrl]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="PrivateKeyPath">[PrivateKeyPath]</InArgument>
        <OutArgument x:TypeArguments="x:String" x:Key="AccessToken">[AccessToken]</OutArgument>
        <OutArgument x:TypeArguments="x:String" x:Key="InstanceUrl">[InstanceUrl]</OutArgument>
        <OutArgument x:TypeArguments="s:DateTime" x:Key="TokenExpiry">[TokenExpiry]</OutArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>
    
    <!-- Validate Token -->
    <ui:InvokeWorkflowFile DisplayName="Validate Token" WorkflowFileName="Activities\ValidateToken.xaml">
      <ui:InvokeWorkflowFile.Arguments>
        <InArgument x:TypeArguments="x:String" x:Key="AccessToken">[AccessToken]</InArgument>
        <InArgument x:TypeArguments="x:String" x:Key="InstanceUrl">[InstanceUrl]</InArgument>
        <OutArgument x:TypeArguments="x:Boolean" x:Key="IsValid">[IsValid]</OutArgument>
        <OutArgument x:TypeArguments="x:String" x:Key="ErrorMessage">[ErrorMessage]</OutArgument>
      </ui:InvokeWorkflowFile.Arguments>
    </ui:InvokeWorkflowFile>
    
    <!-- Log Results -->
    <If DisplayName="Check Authentication Result">
      <If.Condition>
        <InArgument x:TypeArguments="x:Boolean">[IsValid]</InArgument>
      </If.Condition>
      <If.Then>
        <ui:LogMessage DisplayName="Authentication Successful" Level="Info" Message="[&quot;Salesforce JWT Authentication successful. Token expires at: &quot; + TokenExpiry.ToString()]" />
      </If.Then>
      <If.Else>
        <Sequence DisplayName="Authentication Failed Actions">
          <ui:LogMessage DisplayName="Authentication Failed" Level="Error" Message="[&quot;Salesforce JWT Authentication failed: &quot; + ErrorMessage]" />
          <ui:LogMessage DisplayName="Stopping Workflow" Level="Error" Message="Workflow stopped due to authentication failure" />
        </Sequence>
      </If.Else>
    </If>
    
    <!-- Set Output Variables -->
    <Assign DisplayName="Set Output Variables">
      <Assign.To>
        <OutArgument x:TypeArguments="x:String">[AccessToken]</OutArgument>
      </Assign.To>
      <Assign.Value>
        <InArgument x:TypeArguments="x:String">[AccessToken]</InArgument>
      </Assign.Value>
    </Assign>
  </Sequence>
</Activity>