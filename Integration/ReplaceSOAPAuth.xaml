<?xml version="1.0" encoding="UTF-8"?>
<Activity xmlns:scg="clr-namespace:System.Collections.Generic;assembly=mscorlib" x:Class="SalesforceJWT.ReplaceSOAPAuth" xmlns="http://schemas.uipath.com/workflow/activities" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:ui="http://schemas.uipath.com/workflow/activities" xmlns:uix="http://schemas.uipath.com/workflow/activities/uix">
  <Sequence DisplayName="Replace SOAP Authentication with JWT">
    <!-- Variables -->
    <Variable x:TypeArguments="x:String" Name="AccessToken" />
    <Variable x:TypeArguments="x:String" Name="InstanceUrl" />
    <Variable x:TypeArguments="x:DateTime" Name="TokenExpiry" />
    <Variable x:TypeArguments="x:Boolean" Name="IsRefreshed" />
    <Variable x:TypeArguments="x:String" Name="NewToken" />
    <Variable x:TypeArguments="x:DateTime" Name="NewExpiry" />
    
    <!-- Get JWT Token -->
    <InvokeWorkflowFile DisplayName="Get JWT Token" WorkflowFileName="..\Main.xaml">
      <Arguments>
        <Argument x:TypeArguments="x:String" Name="AccessToken" Value="[AccessToken]" />
        <Argument x:TypeArguments="x:String" Name="InstanceUrl" Value="[InstanceUrl]" />
        <Argument x:TypeArguments="x:DateTime" Name="TokenExpiry" Value="[TokenExpiry]" />
      </Arguments>
    </InvokeWorkflowFile>
    
    <!-- Check if token needs refresh before making API calls -->
    <InvokeWorkflowFile DisplayName="Check Token Refresh" WorkflowFileName="Activities\RefreshToken.xaml">
      <Arguments>
        <Argument x:TypeArguments="x:String" Name="CurrentToken" Value="[AccessToken]" />
        <Argument x:TypeArguments="x:DateTime" Name="TokenExpiry" Value="[TokenExpiry]" />
        <Argument x:TypeArguments="x:Boolean" Name="IsRefreshed" Value="[IsRefreshed]" />
        <Argument x:TypeArguments="x:String" Name="NewToken" Value="[NewToken]" />
        <Argument x:TypeArguments="x:DateTime" Name="NewExpiry" Value="[NewExpiry]" />
      </Arguments>
    </InvokeWorkflowFile>
    
    <!-- Use refreshed token if needed -->
    <If DisplayName="Use Refreshed Token">
      <If.Condition>
        <InArgument x:TypeArguments="x:Boolean">[IsRefreshed]</InArgument>
      </If.Condition>
      <If.Then>
        <Assign DisplayName="Update Token">
          <Assign.To>
            <OutArgument x:TypeArguments="x:String">[AccessToken]</OutArgument>
          </Assign.To>
          <Assign.Value>
            <InArgument x:TypeArguments="x:String">[NewToken]</InArgument>
          </Assign.Value>
        </Assign>
        
        <Assign DisplayName="Update Expiry">
          <Assign.To>
            <OutArgument x:TypeArguments="x:DateTime">[TokenExpiry]</OutArgument>
          </Assign.To>
          <Assign.Value>
            <InArgument x:TypeArguments="x:DateTime">[NewExpiry]</InArgument>
          </Assign.Value>
        </Assign>
      </If.Then>
    </If>
    
    <!-- Example: Make API call with JWT token -->
    <HttpRequest DisplayName="Make API Call with JWT Token" Method="GET" Url="[InstanceUrl + '/services/data/v58.0/sobjects/Account/describe']">
      <HttpRequest.Headers>
        <scg:Dictionary x:TypeArguments="x:String, x:String">
          <KeyValuePair x:Key="Authorization" x:Value="[&quot;Bearer &quot; + AccessToken]" />
          <KeyValuePair x:Key="Content-Type" x:Value="application/json" />
        </scg:Dictionary>
      </HttpRequest.Headers>
      <HttpRequest.Result>
        <OutArgument x:TypeArguments="x:String">[APIResponse]</OutArgument>
      </HttpRequest.Result>
    </HttpRequest>
    
    <LogMessage DisplayName="API Call Successful" Level="Info" Message="API call completed successfully with JWT authentication." />
  </Sequence>
</Activity>
